<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Graduon - 한국외국어대학교 컴퓨터공학부 졸업 요건 관리 서비스">
  <meta name="keywords" content="한국외국어대학교, 컴퓨터공학부, 졸업요건, 학점관리">
  <meta name="author" content="Graduon Team">
  <title>Graduon 비밀번호 재설정</title>

  <!-- Favicon 연결 -->
  <link rel="icon" type="image/x-icon" href="/static/asset/favicon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/asset/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/asset/favicon/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/static/asset/favicon/apple-touch-icon.png">
  <link rel="manifest" href="/static/asset/favicon/site.webmanifest">

  <!-- Bootstrap CSS 연결 -->
  <link rel="stylesheet" href="/static/css/bootstrap.min.css">

</head>
<body>
  <div class="container d-flex align-items-center justify-content-center">
    <div class="row col-6 p-5 rounded">
      <a class="text-center mb-4 text-decoration-none" href="/">
        <img src="/static/asset/KakaoTalk_Photo.png" alt="Graduon 로고" class="img-fluid" style="height: 280px;">
      </a>
      
      <div class="alert alert-info" role="alert">
        <h4 class="alert-heading">비밀번호 재설정</h4>
        <p>가입하실 때 사용한 이메일 주소를 입력하시고, "코드 발송"을 눌러주세요. 이메일로 받은 인증 코드와 새 비밀번호를 입력하여 비밀번호를 재설정할 수 있습니다.</p>
        <hr>
        <p class="mb-0">인증 코드는 발송 후 60분간 유효합니다.</p>
      </div>

      <!-- 1단계: 이메일 입력 영역 -->
      <div id="step1" class="step-container">
        <div class="mb-3">
          <input type="email" id="emailInput" class="form-control rounded-pill px-4 py-3 bg-light border-0"
                 placeholder="이메일 주소" required>
        </div>
        
        <button id="sendCodeBtn" class="btn btn-primary w-100 py-3 fw-bold rounded-pill mb-3">
          인증 코드 발송
        </button>
      </div>

      <!-- 2단계: 인증 코드 + 새 비밀번호 입력 영역 -->
      <div id="step2" class="step-container" style="display: none;">
        <div class="mb-3">
          <input type="email" id="emailDisplay" class="form-control rounded-pill px-4 py-3 bg-light border-0"
                 placeholder="이메일 주소" readonly>
        </div>
        
        <div class="mb-3">
          <input type="text" id="codeInput" class="form-control rounded-pill px-4 py-3 bg-light border-0"
                 placeholder="인증 코드 (6자리)" maxlength="6" required>
        </div>
        
        <div class="mb-3">
          <input type="password" id="newPasswordInput" class="form-control rounded-pill px-4 py-3 bg-light border-0"
                 placeholder="새 비밀번호 (4자 이상)" required>
        </div>
        
        <div class="mb-3">
          <input type="password" id="confirmPasswordInput" class="form-control rounded-pill px-4 py-3 bg-light border-0"
                 placeholder="새 비밀번호 확인" required>
        </div>
        
        <button id="resetPasswordBtn" class="btn btn-success w-100 py-3 fw-bold rounded-pill mb-3">
          비밀번호 재설정
        </button>
        
        <button id="backToStep1Btn" class="btn btn-outline-secondary w-100 py-2 fw-bold rounded-pill">
          이메일 다시 입력
        </button>
      </div>
      
      <!-- 로그인 페이지로 돌아가기 링크 -->
      <div class="text-center mt-3">
        <a href="/" class="text-primary text-decoration-none">로그인 페이지로 돌아가기</a>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS 연결 -->
  <script src="/static/js/bootstrap.bundle.min.js"></script>

  <script>
    // 인증 코드 발송 처리 함수
    async function handleSendCode() {
      const emailInput = document.getElementById('emailInput');
      
      // 입력값 검증
      const email = emailInput.value.trim();
      
      if (!email) {
        showAlert('이메일을 입력해주세요.', 'warning');
        emailInput.focus();
        return;
      }
      
      if (!isValidEmail(email)) {
        showAlert('올바른 이메일 형식을 입력해주세요.', 'warning');
        emailInput.focus();
        return;
      }
      
      // 로딩 상태 설정
      setSendCodeLoadingState(true);
      
      try {
        const response = await fetch('/reset-password/request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: email
          })
        });
        
        if (response.status === 200) {
          // 코드 발송 성공
          const data = await response.json();
          showAlert(`인증 코드가 이메일로 발송되었습니다. (${data.try}회 시도)`, 'success');
          
          // 2단계로 이동
          document.getElementById('emailDisplay').value = email;
          showStep2();
          
        } else if (response.status === 400) {
          // 존재하지 않는 이메일
          const errorData = await response.json();
          showAlert(`요청 실패: ${errorData.detail || '존재하지 않는 이메일입니다.'}`, 'danger');
          
        } else if (response.status === 429) {
          // 요청 제한 초과
          const errorText = await response.text();
          showAlert(errorText, 'warning');
          
        } else if (response.status === 422) {
          // 유효성 검증 실패
          const errorData = await response.json();
          showAlert(`입력값 오류: ${errorData.detail || '유효하지 않은 입력입니다.'}`, 'danger');
          
        } else {
          // 기타 오류
          const errorData = await response.json().catch(() => ({}));
          showAlert(`코드 발송 중 오류가 발생했습니다: ${errorData.detail || '알 수 없는 오류입니다.'}`, 'danger');
        }
        
      } catch (error) {
        console.error('Send code error:', error);
        showAlert('네트워크 오류가 발생했습니다. 인터넷 연결을 확인해주세요.', 'danger');
      } finally {
        setSendCodeLoadingState(false);
      }
    }
    
    // 비밀번호 재설정 처리 함수
    async function handleResetPassword() {
      const emailDisplay = document.getElementById('emailDisplay');
      const codeInput = document.getElementById('codeInput');
      const newPasswordInput = document.getElementById('newPasswordInput');
      const confirmPasswordInput = document.getElementById('confirmPasswordInput');
      
      // 입력값 검증
      const email = emailDisplay.value.trim();
      const code = codeInput.value.trim();
      const newPassword = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      
      if (!email) {
        showAlert('이메일이 누락되었습니다. 처음부터 다시 시도해주세요.', 'danger');
        showStep1();
        return;
      }
      
      if (!code) {
        showAlert('인증 코드를 입력해주세요.', 'warning');
        codeInput.focus();
        return;
      }
      
      if (code.length !== 6) {
        showAlert('인증 코드는 6자리입니다.', 'warning');
        codeInput.focus();
        return;
      }
      
      if (!newPassword) {
        showAlert('새 비밀번호를 입력해주세요.', 'warning');
        newPasswordInput.focus();
        return;
      }
      
      if (newPassword.length < 4) {
        showAlert('비밀번호는 4자 이상이어야 합니다.', 'warning');
        newPasswordInput.focus();
        return;
      }
      
      if (!confirmPassword) {
        showAlert('비밀번호 확인을 입력해주세요.', 'warning');
        confirmPasswordInput.focus();
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showAlert('비밀번호가 일치하지 않습니다.', 'warning');
        confirmPasswordInput.value = '';
        confirmPasswordInput.focus();
        return;
      }
      
      // 로딩 상태 설정
      setResetPasswordLoadingState(true);
      
      try {
        const response = await fetch('/reset-password/confirm', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: email,
            code: code,
            new_password: newPassword
          })
        });
        
        if (response.status === 204) {
          // 비밀번호 재설정 성공
          showAlert('비밀번호가 성공적으로 재설정되었습니다! 로그인 페이지로 이동합니다.', 'success');
          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
          
        } else if (response.status === 400) {
          // 인증 실패
          const errorData = await response.json();
          const errorMsg = errorData.detail || '알 수 없는 오류입니다.';
          
          if (errorMsg.includes('코드가 일치하지 않습니다') || errorMsg.includes('코드가 만료되었습니다')) {
            showAlert(`인증 실패: ${errorMsg}`, 'danger');
            codeInput.value = '';
            codeInput.focus();
          } else {
            showAlert(`요청 실패: ${errorMsg}`, 'danger');
          }
          
        } else if (response.status === 422) {
          // 유효성 검증 실패
          const errorData = await response.json();
          showAlert(`입력값 오류: ${errorData.detail || '유효하지 않은 입력입니다.'}`, 'danger');
          
        } else {
          // 기타 오류
          const errorData = await response.json().catch(() => ({}));
          showAlert(`비밀번호 재설정 중 오류가 발생했습니다: ${errorData.detail || '알 수 없는 오류입니다.'}`, 'danger');
        }
        
      } catch (error) {
        console.error('Reset password error:', error);
        showAlert('네트워크 오류가 발생했습니다. 인터넷 연결을 확인해주세요.', 'danger');
      } finally {
        setResetPasswordLoadingState(false);
      }
    }
    
    // 이메일 유효성 검증
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }
    
    // Step 관리 함수들
    function showStep1() {
      document.getElementById('step1').style.display = 'block';
      document.getElementById('step2').style.display = 'none';
      document.getElementById('emailInput').focus();
    }
    
    function showStep2() {
      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').style.display = 'block';
      document.getElementById('codeInput').focus();
    }
    
    // 코드 발송 로딩 상태 관리
    function setSendCodeLoadingState(isLoading) {
      const sendCodeBtn = document.getElementById('sendCodeBtn');
      const emailInput = document.getElementById('emailInput');
      
      if (isLoading) {
        sendCodeBtn.disabled = true;
        sendCodeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>발송 중...';
        emailInput.disabled = true;
      } else {
        sendCodeBtn.disabled = false;
        sendCodeBtn.innerHTML = '인증 코드 발송';
        emailInput.disabled = false;
      }
    }
    
    // 비밀번호 재설정 로딩 상태 관리
    function setResetPasswordLoadingState(isLoading) {
      const resetPasswordBtn = document.getElementById('resetPasswordBtn');
      const backToStep1Btn = document.getElementById('backToStep1Btn');
      const codeInput = document.getElementById('codeInput');
      const newPasswordInput = document.getElementById('newPasswordInput');
      const confirmPasswordInput = document.getElementById('confirmPasswordInput');
      
      if (isLoading) {
        resetPasswordBtn.disabled = true;
        resetPasswordBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>재설정 중...';
        backToStep1Btn.disabled = true;
        codeInput.disabled = true;
        newPasswordInput.disabled = true;
        confirmPasswordInput.disabled = true;
      } else {
        resetPasswordBtn.disabled = false;
        resetPasswordBtn.innerHTML = '비밀번호 재설정';
        backToStep1Btn.disabled = false;
        codeInput.disabled = false;
        newPasswordInput.disabled = false;
        confirmPasswordInput.disabled = false;
      }
    }
    
    // 알림 메시지 표시
    function showAlert(message, type = 'info') {
      // 기존 알림 제거
      const existingAlert = document.querySelector('.alert:not(.alert-info)');
      if (existingAlert) {
        existingAlert.remove();
      }
      
      // 새 알림 생성
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      // 현재 보이는 step의 첫 번째 버튼 위에 삽입
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      
      if (step1.style.display !== 'none') {
        const sendCodeBtn = document.getElementById('sendCodeBtn');
        sendCodeBtn.parentNode.insertBefore(alertDiv, sendCodeBtn);
      } else {
        const resetPasswordBtn = document.getElementById('resetPasswordBtn');
        resetPasswordBtn.parentNode.insertBefore(alertDiv, resetPasswordBtn);
      }
      
      // 3초 후 자동 제거 (danger와 warning은 5초)
      const timeout = (type === 'danger' || type === 'warning') ? 5000 : 3000;
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, timeout);
    }
    
    // 이벤트 리스너 등록
    document.addEventListener('DOMContentLoaded', function() {
      const sendCodeBtn = document.getElementById('sendCodeBtn');
      const resetPasswordBtn = document.getElementById('resetPasswordBtn');
      const backToStep1Btn = document.getElementById('backToStep1Btn');
      const emailInput = document.getElementById('emailInput');
      const codeInput = document.getElementById('codeInput');
      const newPasswordInput = document.getElementById('newPasswordInput');
      const confirmPasswordInput = document.getElementById('confirmPasswordInput');
      
      // 버튼 클릭 이벤트
      sendCodeBtn.addEventListener('click', handleSendCode);
      resetPasswordBtn.addEventListener('click', handleResetPassword);
      backToStep1Btn.addEventListener('click', function() {
        showStep1();
        // 입력값 초기화
        document.getElementById('codeInput').value = '';
        document.getElementById('newPasswordInput').value = '';
        document.getElementById('confirmPasswordInput').value = '';
      });
      
      // Enter 키 처리 - Step 1
      emailInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          handleSendCode();
        }
      });
      
      // Enter 키 처리 - Step 2
      codeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          newPasswordInput.focus();
        }
      });
      
      newPasswordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          confirmPasswordInput.focus();
        }
      });
      
      confirmPasswordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          handleResetPassword();
        }
      });
      
      // 인증 코드 입력 시 자동으로 대문자 변환 및 숫자/문자만 허용
      codeInput.addEventListener('input', function(e) {
        let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (value.length > 6) {
          value = value.substring(0, 6);
        }
        e.target.value = value;
      });
      
      // 페이지 로드 시 이메일 입력 필드에 포커스
      emailInput.focus();
    });
  </script>

</body>
</html>

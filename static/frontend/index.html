<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Graduon - í•œêµ­ì™¸êµ­ì–´ëŒ€í•™êµ ì»´í“¨í„°ê³µí•™ë¶€ ì¡¸ì—… ìš”ê±´ ê´€ë¦¬ ì„œë¹„ìŠ¤">
  <meta name="keywords" content="í•œêµ­ì™¸êµ­ì–´ëŒ€í•™êµ, ì»´í“¨í„°ê³µí•™ë¶€, ì¡¸ì—…ìš”ê±´, í•™ì ê´€ë¦¬">
  <meta name="author" content="Graduon Team">
  <title>Graduon ë¡œê·¸ì¸</title>

  <!-- Favicon ì—°ê²° -->
  <link rel="icon" type="image/x-icon" href="/static/asset/favicon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/asset/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/asset/favicon/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/static/asset/favicon/apple-touch-icon.png">
  <link rel="manifest" href="/static/asset/favicon/site.webmanifest">

  <!-- Bootstrap CSS ì—°ê²° -->
  <link rel="stylesheet" href="/static/css/bootstrap.min.css">

</head>
<body >
  <div class="container d-flex align-items-center justify-content-center">
    <div class="row col-6 p-5 rounded">
      <div class="text-center mb-4">
        <img src="/static/asset/KakaoTalk_Photo.png" alt="Graduon ë¡œê³ " class="img-fluid" style="height: 280px;">
      </div>

      <!-- ë¡œê·¸ì¸ ì…ë ¥ ì˜ì—­ -->
      <div class="mb-3">
        <input type="email" id="emailInput" class="form-control rounded-pill px-4 py-3 bg-light border-0" 
               placeholder="ì´ë©”ì¼ ì£¼ì†Œ" required>
      </div>

      <div class="mb-1">
        <input type="password" id="passwordInput" class="form-control rounded-pill px-4 py-3 bg-light border-0" 
               placeholder="ë¹„ë°€ë²ˆí˜¸" required>
      </div>

      <div class="d-flex justify-content-between mb-2 px-1 small">
        <a href="/forgot-password" class="text-primary text-decoration-none">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠì–´ë²„ë¦¬ì…¨ë‚˜ìš”?</a>
        <a href="/signup" class="text-primary text-decoration-none">íšŒì›ê°€ì…</a>
      </div>

      <!-- ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ ì¤„ -->
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="rememberMe">
        <label class="form-check-label" for="rememberMe">ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€</label>
      </div>

      <!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
      <button id="loginBtn" class="btn btn-primary w-100 py-3 fw-bold rounded-pill">
        ë¡œê·¸ì¸
      </button>

      <div class="d-flex align-items-center my-4">
        <hr class="flex-grow-1">
        <span class="px-3 text-muted small">ë˜ëŠ”</span>
        <hr class="flex-grow-1">
      </div>

      <!-- ì†Œì…œ ë¡œê·¸ì¸ -->
      <button class="btn btn-light w-100 mb-2" onclick="location.href='/auth/google/login'">G Google ë¡œê·¸ì¸</button>
      <button class="btn btn-success w-100 mb-2" onclick="location.href='/auth/naver/login'">N ë„¤ì´ë²„ ë¡œê·¸ì¸</button>
      <button class="btn btn-warning w-100" onclick="location.href='/auth/kakao/login'">ğŸ—¨ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸</button>
    </div>
  </div>

  <!-- Bootstrap JS ì—°ê²° -->
  <script src="/static/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
    async function handleLogin() {
      const emailInput = document.getElementById('emailInput');
      const passwordInput = document.getElementById('passwordInput');
      const rememberMe = document.getElementById('rememberMe');

      // ì…ë ¥ê°’ ê²€ì¦
      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!email) {
        showAlert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        emailInput.focus();
        return;
      }

      if (!isValidEmail(email)) {
        showAlert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        emailInput.focus();
        return;
      }

      if (!password) {
        showAlert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        passwordInput.focus();
        return;
      }

      if (password.length < 4) {
        showAlert('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'warning');
        passwordInput.focus();
        return;
      }

      // ë¡œë”© ìƒíƒœ ì„¤ì •
      setLoadingState(true);

      try {
        const response = await fetch('/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: email,
            password: password,
            session_continue: rememberMe.checked
          })
        });

        if (response.status === 204) {
          // ë¡œê·¸ì¸ ì„±ê³µ
          showAlert('ë¡œê·¸ì¸ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!', 'success');
          // ëŒ€ì‹œë³´ë“œë‚˜ ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì„ì‹œë¡œ ìƒˆë¡œê³ ì¹¨)
          setTimeout(() => {
            window.location.href = '/dashboard'; // TODO ì‹¤ì œ URLë¡œ ë³€ê²½
          }, 1000);
        } else if (response.status === 206) {
          // ì´ë©”ì¼ ì¸ì¦ ë¯¸ì™„ë£Œ
          showAlert('ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ ì¸ì¦ì„ ë¨¼ì €í•˜ê³  ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'warning');
          setTimeout(() => {
            window.location.href = '/verify-email';
          }, 1000);
        } else if (response.status === 403) {
          // ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜
          showAlert('ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'danger');
          passwordInput.value = '';
          passwordInput.focus();
        } else if (response.status === 422) {
          // ìœ íš¨ì„± ê²€ì¦ ì‹¤íŒ¨
          const errorData = await response.json();
          showAlert(`ì…ë ¥ê°’ ì˜¤ë¥˜: ${errorData.detail || 'ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ì…ë‹ˆë‹¤. ê°œë°œìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'}`, 'danger');
        } else {
          // ê¸°íƒ€ ì˜¤ë¥˜
          const errorData = await response.json().catch(() => ({}));
          showAlert(`ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${errorData.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜. ê°œë°œìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'}`, 'danger');
        }
      } catch (error) {
        console.error('Login error:', error);
        showAlert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'danger');
      } finally {
        setLoadingState(false);
      }
    }

    // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì¦
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // ë¡œë”© ìƒíƒœ ê´€ë¦¬
    function setLoadingState(isLoading) {
      const loginBtn = document.getElementById('loginBtn');
      const emailInput = document.getElementById('emailInput');
      const passwordInput = document.getElementById('passwordInput');

      if (isLoading) {
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>ë¡œê·¸ì¸ ì¤‘...';
        emailInput.disabled = true;
        passwordInput.disabled = true;
      } else {
        loginBtn.disabled = false;
        loginBtn.innerHTML = 'ë¡œê·¸ì¸';
        emailInput.disabled = false;
        passwordInput.disabled = false;
      }
    }

    // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
    function showAlert(message, type = 'info') {
      // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
      const existingAlert = document.querySelector('.alert');
      if (existingAlert) {
        existingAlert.remove();
      }

      // ìƒˆ ì•Œë¦¼ ìƒì„±
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;

      // ë¡œê·¸ì¸ ë²„íŠ¼ ìœ„ì— ì‚½ì…
      const loginBtn = document.getElementById('loginBtn');
      loginBtn.parentNode.insertBefore(alertDiv, loginBtn);

      // 3ì´ˆ í›„ ìë™ ì œê±° (dangerì™€ warningì€ 5ì´ˆ)
      const timeout = (type === 'danger' || type === 'warning') ? 5000 : 3000;
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, timeout);
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('DOMContentLoaded', async function() {
      const loginBtn = document.getElementById('loginBtn');
      const emailInput = document.getElementById('emailInput');
      const passwordInput = document.getElementById('passwordInput');

      // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
      loginBtn.addEventListener('click', handleLogin);

      // Enter í‚¤ ì²˜ë¦¬
      emailInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          passwordInput.focus();
        }
      });

      passwordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          handleLogin();
        }
      });

      // ì´ë©”ì¼ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
      emailInput.focus();
    });
  </script>

</body>
</html>
